<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="如何设计一个积分兑换系统">




  <meta name="keywords" content="系统设计,">





  <link rel="alternate" href="/default" title="Illusory">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1">



<link rel="canonical" href="http://yaoper.github.io/2020/01/05/如何设计一个积分兑换系统/">


<meta name="description" content="1. 业务需求描述用户在电商平台通过购物评论晒单累计了一定的积分，积分达到一定数量的时候可以在积分中心页面兑换心仪的物品。 2. 业务流程的思考用户的购物评论晒单行为会不断的累积积分，那么这里就需要一个积分表来记录用户的积分。 积分表    列名 属性 备注    id 主键ID 自增   user_id 用户ID    credit 积分    用户使用积分兑换商品以后需要扣除商品对应的积分，这">
<meta name="keywords" content="系统设计">
<meta property="og:type" content="article">
<meta property="og:title" content="如何设计一个积分兑换系统">
<meta property="og:url" content="http://yaoper.github.io/2020/01/05/如何设计一个积分兑换系统/index.html">
<meta property="og:site_name" content="Illusory">
<meta property="og:description" content="1. 业务需求描述用户在电商平台通过购物评论晒单累计了一定的积分，积分达到一定数量的时候可以在积分中心页面兑换心仪的物品。 2. 业务流程的思考用户的购物评论晒单行为会不断的累积积分，那么这里就需要一个积分表来记录用户的积分。 积分表    列名 属性 备注    id 主键ID 自增   user_id 用户ID    credit 积分    用户使用积分兑换商品以后需要扣除商品对应的积分，这">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-01-05T03:52:16.186Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何设计一个积分兑换系统">
<meta name="twitter:description" content="1. 业务需求描述用户在电商平台通过购物评论晒单累计了一定的积分，积分达到一定数量的时候可以在积分中心页面兑换心仪的物品。 2. 业务流程的思考用户的购物评论晒单行为会不断的累积积分，那么这里就需要一个积分表来记录用户的积分。 积分表    列名 属性 备注    id 主键ID 自增   user_id 用户ID    credit 积分    用户使用积分兑换商品以后需要扣除商品对应的积分，这">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> 如何设计一个积分兑换系统 - Illusory </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Illusory</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          如何设计一个积分兑换系统
        
      </h1>

      <time class="post-time">
          Jan 05 2020
      </time>
    </header>



    
            <div class="post-content">
            <h4 id="1-业务需求描述"><a href="#1-业务需求描述" class="headerlink" title="1. 业务需求描述"></a>1. 业务需求描述</h4><p>用户在电商平台通过购物评论晒单累计了一定的积分，积分达到一定数量的时候可以在积分中心页面兑换心仪的物品。</p>
<h4 id="2-业务流程的思考"><a href="#2-业务流程的思考" class="headerlink" title="2. 业务流程的思考"></a>2. 业务流程的思考</h4><p>用户的购物评论晒单行为会不断的累积积分，那么这里就需要一个积分表来记录用户的积分。</p>
<p><u>积分表</u></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>属性</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>主键ID</td>
<td>自增</td>
</tr>
<tr>
<td>user_id</td>
<td>用户ID</td>
<td></td>
</tr>
<tr>
<td>credit</td>
<td>积分</td>
<td></td>
</tr>
</tbody></table>
<p>用户使用积分兑换商品以后需要扣除商品对应的积分，这时需要一张商品兑换表来记录兑换记录。</p>
<p><u>积分兑换表</u></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>属性</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>主键ID</td>
<td>自增</td>
</tr>
<tr>
<td>user_id</td>
<td>用户ID</td>
<td></td>
</tr>
<tr>
<td>exchanged_credit</td>
<td>用于兑换的积分</td>
<td></td>
</tr>
<tr>
<td>product_id</td>
<td>兑换的商品ID</td>
<td></td>
</tr>
</tbody></table>
<p>商品兑换完以后是不是要给用户发货，需要向库存中心提交一个发货申请呢？这个时候可以搞一个发货申请表。</p>
<p><u>发货申请表</u><br>| 列名 | 属性 | 备注 |<br>| —- | —- | —- |<br>|id|主键ID|自增|<br>|type|发货类型|1：购买，2：积分兑换|<br>|credit_exchange_id|积分兑换表ID||<br>|product_id|商品ID||</p>
<p>申请发货后需要一个生产一个物流单号给用户反馈物流信息，可以扩展发货申请表添加一个物流单号</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>属性</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>主键ID</td>
<td>自增</td>
</tr>
<tr>
<td>type</td>
<td>发货类型</td>
<td>1：购买，2：积分兑换</td>
</tr>
<tr>
<td>credit_exchange_id</td>
<td>积分兑换表ID</td>
<td></td>
</tr>
<tr>
<td>product_id</td>
<td>商品ID</td>
<td></td>
</tr>
<tr>
<td>express_no</td>
<td>物流单号</td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-技术需求的思考"><a href="#3-技术需求的思考" class="headerlink" title="3. 技术需求的思考"></a>3. 技术需求的思考</h4><p>业务流程理顺以后就是技术的思考，这个业务系统有没有事务，如何保证<strong>事务</strong>？
扣减积分、新增积分兑换记录、新增发货申请单，这三个步骤必须是要么一起完成，要么一起失败的。也就是说，这三个步骤必须是在一个事务里的，这个时候可以引入分布式事务。</p>
<p>上述设计其实理论上是没问题的，但是这里你忽略了一个问题，在这个业务场景中，积分服务是没有必要同步调用仓储服务的。<br>因为积分兑换是一个用户执行的操作，假设你的仓储服务在生成发货申请单的时候调用第三方物流公司的接口，被卡住了，或者失败了，怎么办？<br>此时可能导致用户在页面上看到积分兑换按钮点击之后，卡在那儿可能几十秒都无法执行成功，所以这个系统如此设计是错误的。<br>那应该怎么做呢？你必须得在这里引入<strong>消息中间件</strong>进行异步化的解耦，保证用户点击积分兑换按钮之后，尽快返回。</p>
<p>到这里就OK了吗？还没呢！<br>一旦引入消息中间件之后，好处是用户点击积分兑换按钮，直接就是在积分服务里扣减积分以及新增积分兑换记录，然后发送一条消息到消息中间件里就结束了，速度很快，保证了用户体验。<br>但是坏处就是，万一仓储服务执行新增发货申请失败了怎么办？<br>这个时候就需要引入<strong>可靠消息服务</strong>了，他需要去保证仓储服务一定会完成新增发货申请这个事。<br>具体的流程如下：</p>
<ol>
<li>积分服务发送消息给可靠消息服务，可靠消息服务在消息表中新增记录，然后发送消息到MQ（消息中间件）</li>
<li>然后仓储服务消费消息新增发货申请单，如果成功就回调可靠消息服务的一个接口说自己成功了，可靠消息服务就可以更新本地消息表中的记录状态为成功</li>
<li>如果仓储服务长时间没通知可靠消息服务自己成功了，可靠消息服务不停的重试再次发送消息</li>
<li>通过这样的设计，就可以保证可靠消息服务一定会<strong>无限次重试</strong>保证让仓储服务成功执行。</li>
</ol>
<p>最后一个问题，如果仓储服务卡在第三方物流系统申请物流单的环节，长时间阻塞，所以没回调通知可靠消息服务。<br>但是可靠消息服务过了一段时间，感觉没收到回调通知，就自己重试发送了消息，这样岂不是会让仓储服务新增两条发货申请单？<br>因此我们还要保证仓储服务新增发货申请单的<strong>幂等性</strong>，其实也非常简单，回顾一下发货申请单表的结构，只要在“credit_exchange_id”字段上建立一个唯一索引就可以了，保证每个积分兑换记录只能创建一条发货申请单，如果重复创建就会被唯一索引被阻止，这样就可以保证这个行为的幂等性了。</p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/系统设计/">系统设计</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/01/08/如何办理联通8元全国流量王/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">如何办理联通8元全国流量王</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/01/04/有一千万个键值对在Redis如果高效存储/">
        <span class="next-text nav-default">有一千万个键值对在Redis如果高效存储？</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2020
    <span class="footer-author">yaoper.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
